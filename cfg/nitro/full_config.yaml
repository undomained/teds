# Cobined config file for all steps in E2E analysis.
#
header:
    file_name: 'full_config.yaml'
    version: '0.000'
#########################################################
# General settings. 
# Used by more than one step in the E2E simulator
#########################################################
io: 
    base_dir: '../data/no2/'
##GM IO
    gm: 'geometry.nc'
## SGM IO
    sgm_rad: 'sgm_radiance.nc'
#    sgm_rad: 'sgm_radiance_wide.nc'
    sgm_atm_raw: 'sgm_atmosphere_raw.nc'
    sgm_atm: 'sgm_atmosphere.nc'
## L2 IO
    l2: 'l2.nc'
## IM & L1B IO
    binning_table: '../data/no2/ckd/binning_table_no2.nc'
    # Input IM:
    # Note: in run_E2E.py this is renamed to l1b
    l1b_im: 'sgm_radiance.nc'
#    l1b_im: 'sgm_radiance_wide.nc'
    # output of IM (and input for L1AL1B):
    l1a: 'l1a.nc'
    # output of L1AL1B:
    l1b: 'l1b.nc'
#####
    # possibility to have different ckds for IM and L1B
    # CKD for L1AL1B
    ckd: '../data/no2/ckd/ckd_nitro.nc'
#    ckd: '../data/no2/ckd/ckd_nitro_updated.nc'
    # L1B uses ckd. IM uses ckd_im
    # Note: in run_E2E.py this is renamed to ckd
    ckd_im: '../data/no2/ckd/ckd_nitro.nc'
#    ckd_im: '../data/no2/ckd/ckd_nitro_updated.nc'
#####
    # Define in between output files for IM (Python version)
    # Base name:
    im_algo_output: 'im_l1x_{algo_name}.nc'
    # Define in between output files for L1B (Python version)
    # Base name:
    l1b_algo_output: 'l1b_l1x_{algo_name}.nc'
#########################################################
#
# GM 
# Configuration file for running the geometry module
#
#########################################################
#
GM: 
    profile: orbit
#        
    orbit:
      epoch: 2022-08-12T12:00:00
      sat_height: 500.0     # km
      eccentricity: 0.0
      arg_perigee: 0.0
      mean_anomaly: 0.0
      ltan: 13.823            # decimal hours
      mean_motion_dot: 0.0
      drag_coeff: 0.0
      propagation_duration: 1.67 #hours
#
    sensors:
      sensor_00__00:
        n_ground_pixels: 100
        swath_width: 30.0   # km
        integration_time: 0.04 # seconds
        start_time: 13.73 # minutes wrt orbit epoch
        end_time: 13.80   # minutes wrt orbit epoch
        pitch: 0.0
        roll: 0.0
        yaw: 0.0
    # gm_title: 'Tango E2ES GM output'
#########################################################
#
# SGM nitro 
# Configuration file for running the SGM nitro module
#
#########################################################
SGM:
    kernel_parameter:               #parameter to configure the 2D blurring of the scene
        type:    2D Gaussian        #type pf kernel, current version has only one option
        fwhm_x:  300                #FWHM in ACT direction
        fwhm_y:  300                #FWHM in flight direction
        size_factor: 2              #the size of the convolution kernel in units of fwhm
    
    atm: # atm simulation settings
        type: cams                  # cams or afgl atmosphere
        gases: [no2, o3]            # for now only no2 and o3
        afgl:
            nlay: 30                #number of atmospheric layers
            dzlay: 1000             #geometrical thickness of the layers [m]
            path: '../data/no2/prof.AFGL.US.std'
        cams:
            path: '../data/cams/cams_global_forecast_20230523.nc' # only contains 00:00 and 12:00 timeslices, 137 layers
            start: 2023-05-23T09:30:00  # different from GM date because it has to match microHH date
        microHH:
            use: True               # replace lower atm with microHH
            path_data: '../data/no2/microHH/Jaenschwalde/'
            gases: [no2]
            filesuffix: src3_20180523_0930
            forced: True
            dump: '../data/no2/tmp/microHH_dump.pkl'
        dem:                       # correct surface pressure using tropomi dem (3k radius), only for CAMS
            use: True
            path: '../data/no2/dem.nc'
    
    rtm:   # disamar (RTM) settings
        tmp_dir:    '../data/no2/tmp/'
        disamar_cfg_template: '../cfg/nitro/disamar_config_sim.in_template'
        disamar_exe: '../data/no2/disamar/Disamar_old.exe'
        dismas_sim: True
        dismas_fwhm: 0.05       #nm
        n_threads: 16
        wave_start: 395         #nm
        wave_end:   502         #nm
        dwave:      0.05        #nm
        cleanup: True # rm disamartmp directory when finished
    
    S2_albedo:
        band: B01
        # B01: 442.7 nm (S2A), 442.3 nm (S2B) 60m
        # B02: 492.4 nm (S2A), 492.1 nm (S2B)    10m
        forced:   True     
        dump: '../data/no2/tmp/sgm_dumpfile.pkl'
    
#########################################################
#
# IM specific
# Configuration file for running the Instrument module
#
#########################################################
############################
IM:
    do_python: false
#    do_python: true
    proctable:
        file: '../cfg/nitro/proctable.yaml'
        algo_list: 'algos_im'
    instrument: 'nitro'
    processing_version: 0.000
    cal_level: 'l1a' # To indicate wether to uncalibrate the whole way (l1a) or to stop at a certain point ('prnu' -> uncalibrate until (NOT INCLUDING) prnu step)
    image_start: 0
#    image_end: 105
    image_end: 2
    detector:
        binning_table_id: 1         # across track binning
#        binning_table_id: 2         # across track binning
        exposure_time:    0.021     # exposure time [sec]
        nr_coadditions:   2         # along track co-adding
    isrf:
        enabled: true      # apply spectral convolution (true) or not (false)
        fwhm_gauss: 0.6    #full width half max [nm] (for carbon: 0.45 and for nitro 0.60)
    noise:
    #    enabled: false      # Add noise (true) or not (false)
        enabled: true      # Add noise (true) or not (false)
        seed:    100       # Seed for noise generation
    dark:
        enabled: true      # apply dark current and dark offset (true) or not (false)
    nonlin:
    #    enabled: true      # apply non linearity (true) or not (false)
        enabled: false     # apply non linearity (true) or not (false)
    prnu:
        enabled: true      # apply PRNU and QE (true) or not (false)
    stray:
    #    enabled: true      # apply straylight (true) or not (false)
        enabled: false     # apply straylight (true) or not (false)
    rad:
        enabled: true      # apply radiametric (true) or not (false)
    #    enabled: false     # apply radiametric (true) or not (false)
#########################################################
#
# L1AL1B specific
# Configuration file for running the L1AL1B module 
#
#########################################################
############################
L1AL1B:
    do_python: false
#    do_python: true
    proctable:
        file: '../cfg/nitro/proctable.yaml'
        algo_list: 'algos_l1b'
    instrument: 'nitro'
    processing_version: 0.000
    image_start: 0
#    image_end: 105
    image_end: 2
    cal_level: 'l1b' # To indicate wether to calibrate the whole way (l1b) or to stop at a certain point ('prnu' -> calibrate until (NOT INCLUDING) prnu step)
# What about geolocation??????
    noise:
#        enabled: false      # apply noise calibration (true) or not (false)
        enabled: true      # apply noise calibration (true) or not (false)
    dark:
        enabled: true      # apply dark current and dark offset corrections (true) or not (false)
    nonlin:
#        enabled: true      # apply non linearity correction(true) or not (false)
        enabled: false     # apply non linearity correction(true) or not (false)
    prnu:
        enabled: true      # apply PRNU and QE corrections (true) or not (false)
    stray:
        enabled: false     # apply straylight correction (true) or not (false)
        van_cittert_steps: 0  #van Citter iteration for stray light correction (0=no correction)
#        enabled: true      # apply straylight correction (true) or not (false)
#        van_cittert_steps: 4  #van Citter iteration for stray light correction (0=no correction)
    rad:
        enabled: true      # apply radiometric correction (true) or not (false)
#        enabled: false     # apply radiometric correction (true) or not (false)
#############################    
#########################################################
#
# L1L2 nitro 
# Configuration file for running the L1L2 nitro module
#
#########################################################
L1L2:
    # start and stop pixels along-track and across-track
    # alt:
    #     start: 0
    #     stop: 16
    # act:
    #     start: 0
    #     stop: 16

    threads: 6 # on KNMI workstation optimum around 6 threads

    rad_from_sgm: no
    irr_from_sgm: yes
    convolve_irr: yes # Convolve SGM irradiance with Gaussian ISRF FWHM from IM

    export_spectra: no
    debug:
        plot: no
        log: no

    # The window for the DOAS fit.
    fit_window: [405.0, 465.0] 

    #The number of coefficients of the DOAS polynomial (which is the degree of the polynomial + 1)# minimum is 3, maximum is 10.
    polynomial_coefs: 6

    #List of the trace gases to use, separated by spaces, e.g.: NO2  O3  O2O2  H2Ovap  H2Oliq
    # Do NOT include 'Ring' here!
    # Use 'None' for zero trace gases, i.e. fit only a polynomial.
    trace_gas_list: [NO2, O3]

    # Specify whether and if so how to fit the Ring spectrum:
    #    No  = do not apply Ring correction
    #    Iring = use the non-linear Ring correction approach,
    #            based on the Ring radiance spectrun Iring   
    #    sigma = use the linear Ring correction approach,    
    #            based on the differential Ring spectrum     
    ring_fit_term: No

    # Number of intensity offset correction coefficients:
    #    0 = no intensity offset correction
    #    1 = a constant   offset correction : Aoff
    #    2 = a linear     offset correction : Aoff + Boff*lambda
    # Note that fitting an intensity offset makes no sense if all
    # else there is to fit is a polynomial.
    # scaling factor Soff:  scaling factor to absorb the unit of IO(w)
    intensity_coefs: 0
    intensity_scaling_factor: 1.0

    # Maximum number of iterations to use in the DOAS fit
    max_iterations: 8

    # Spike removal: off/on
    spike_removal: off
    
    #Max number of outliers that iis accepted
    max_outliers: 10

    # convergence threshold for OE
    convergence_threshold: 1.0

    # ---- Reference Spectra ----
    # ref spec convolved with FWHM 0.6 nm
    ref_solar: ../data/no2/refspec_06/solar_irradiance.xs
    ref_xs_no2: ../data/no2/refspec_06/no2.xs
    ref_xs_o3: ../data/no2/refspec_06/o3.xs


    # ---- Wavelength calibration ----

    # Wavelength calibation for solar and earth spectra (off/on)
    wlcal_solar: off
    wlcal_earth: off

    # Include wavelength stretch in wavelength calibration(off/on)
    wlcal_solar_stretch: off
    wlcal_earth_stretch: off

    # window to use for the calibration, but use the full  
    #                   fit window if wlcal_[solar/earth]_stretch = 1
    wlcal_window: [405.0, 465.0]

    # prior values for OE: [value, error]
    prior:
        doas: # P is polynomial, C is intensity offset
            P0: [1.0, 1.0]
            P1: [0.015625, 0.015625]
            P2: [0.015625, 0.015625]
            P3: [0.015625, 0.015625]
            P4: [0.015625, 0.015625]
            P5: [0.015625, 0.015625]
            C0: [1.0, 1.0]
            C1: [0.125, 0.125]
            C2: [0.015625, 0.015625]
            C3: [0.015625, 0.015625]
            Cring: [0.06, 0.2]
            Dring: [0.06, 0.2]
            NO2: [1.2e-5, 1.0e-2]
            O2O2: [8.0e+5, 2.0e+6]
            O3: [3.6e-1, 5.0]
            H20vap: [1.5e+3, 1.0e+4]
            H20liq: [0.0, 20.0]
        
        wvl_cal: # ws = shift, wq = stretch/squeeze, error: 1/3th of spacing of nominal grid: sigma=dlambda/3
            ws: [0.0, 0.07]
            wq: [0.0, 0.07]
            P0: [1.0, 1.0]
            P1: [0.1, 0.1]
            P2: [0.01, 0.01]
            Cring: [0.06, 0.06]
            Dring: [0.06, 0.06]

    LUT_NN_file: ../data/no2/LUT_NN_combined_20231113.nc # file containing a neural network of the NO2 look-up tables

########################################################
#
# PAM nitro
# Configuration file for running the perfomance assesment module
#
#########################################################
PAM:
    figure_dir: ../data/no2/tmp/figs/
    plot_list: { # usage: '{title}' : {'sgm_name':{var name in SGM file}, 'l2_name':{var name in L2 file}
                'NO2 vertical column': {'sgm_name':'col_no2', 'l2_name':'no2_total_vcd'}
    }
