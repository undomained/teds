# This source code is licensed under the 3-clause BSD license found in
# the LICENSE file in the root directory of this project.

target_sources(tango_l1b PRIVATE
  array.cpp
  bspline.cpp
  fourier.cpp
  functions.cpp
  inversion.cpp
  lininv.cpp
  matrix.cpp
  multigaussfit.cpp
  netcdf_object.cpp
  planet.cpp
  settings.cpp
  splitgaussfit.cpp
  theodolite.cpp
  vector.cpp
  logger.cpp
  batch.cpp
  binningtable.cpp
  ckd.cpp
  darkcal.cpp
  dimcal.cpp
  fovcal.cpp
  l1a_calibration.cpp
  l1a.cpp
  l1a_file_metadata.cpp
  l1a_flight.cpp
  l1a_manager.cpp
  l1b.cpp
  l1c.cpp
  l1x.cpp
  main.cpp
  noisecal.cpp
  nonlincal.cpp
  prnucal.cpp
  processor.cpp
  radcal.cpp
  settings_main.cpp
  settings_proc.cpp
  straycal.cpp
  swathcal.cpp
  wavecal.cpp
  tango_cal.cpp
  l1a_frames.cpp
  cubic_spline.cpp
  parallel.cpp
)

add_custom_target(gitfile
  COMMAND ${CMAKE_COMMAND}
  -D PROJECT_SOURCE_DIR=${PROJECT_SOURCE_DIR}
  -P ${PROJECT_SOURCE_DIR}/cmake/modules/get_git_info.cmake)
add_dependencies(tango_l1b gitfile)

target_include_directories(tango_l1b PUBLIC
  ${CMAKE_CURRENT_BINARY_DIR})

# Link against a linear algebra library
if (LINALG_FLAVOR MATCHES "mkl")
  # If LINALG_FLAVOR has been set then use that library
  find_package(MKL REQUIRED)
  target_include_directories(tango_l1b PUBLIC ${MKL_INCLUDE_DIR})
  target_link_libraries(tango_l1b PUBLIC ${MKL_LIBRARIES})
  target_compile_definitions(tango_l1b PUBLIC USE_MKL)
  set(linalg_library_name "MKL")
else()
  # Otherwise attempt to detect if MKL is used
  try_compile(LINALG_TEST ${CMAKE_CURRENT_BINARY_DIR}
    ${PROJECT_SOURCE_DIR}/cmake/tests/MKL.cpp
    CMAKE_FLAGS
    "-DINCLUDE_DIRECTORIES=${INCLUDE_PATHS}"
    "-DLINK_DIRECTORIES=${LIBRARY_PATHS}"
    "-DLINK_LIBRARIES=${LIBRARIES}")
  if (LINALG_TEST)
    target_compile_definitions(tango_l1b PUBLIC USE_MKL)
    set(linalg_library_name "MKL")
  else()
    set(linalg_library_name "system default")
  endif()
endif()
message("Using linear algebra library: ${linalg_library_name}")
